---
phase: 01-performance-fix
plan: 03
type: execute
wave: 2
depends_on: ["01-02"]
files_modified:
  - app/src/main/java/com/lxmf/messenger/ColumbaApplication.kt
  - app/src/main/java/com/lxmf/messenger/MainActivity.kt
autonomous: true

must_haves:
  truths:
    - "Sentry captures slow frame events in production builds"
    - "Sentry captures ANR events with thread dumps"
    - "Performance monitoring can be verified in Sentry dashboard"
  artifacts:
    - path: "app/src/main/java/com/lxmf/messenger/ColumbaApplication.kt"
      provides: "Sentry performance monitoring initialization"
      contains: "enableTracing"
    - path: "app/src/main/java/com/lxmf/messenger/MainActivity.kt"
      provides: "JankStats integration for frame monitoring"
      contains: "JankStats"
  key_links:
    - from: "ColumbaApplication.kt"
      to: "Sentry SDK"
      via: "tracing configuration"
      pattern: "tracesSampleRate"
---

<objective>
Add Sentry performance monitoring to detect slow frames and ANRs in production, enabling proactive performance issue detection going forward.

Purpose: Establish ongoing production observability for performance issues (user requested: "Add Sentry/crash reporting for slow frames or ANRs going forward").
Output: Production performance monitoring via Sentry with slow frame and ANR detection.
</objective>

<execution_context>
@/home/tyler/.claude/get-shit-done/workflows/execute-plan.md
@/home/tyler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-performance-fix/01-CONTEXT.md
@.planning/phases/01-performance-fix/01-RESEARCH.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/STACK.md
@app/build.gradle.kts
@app/src/main/java/com/lxmf/messenger/ColumbaApplication.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enable Sentry performance monitoring with slow frame detection</name>
  <files>app/src/main/java/com/lxmf/messenger/ColumbaApplication.kt</files>
  <action>
Configure Sentry SDK (already in project at v7.3.0) to capture performance data including slow frames and ANRs.

**Sentry Configuration Updates:**

1. Locate the Sentry initialization in ColumbaApplication.kt (likely in onCreate or a CrashReportManager).

2. Update the Sentry options to enable performance monitoring:

```kotlin
SentryAndroid.init(this) { options ->
    // Existing DSN configuration...

    // Enable performance monitoring
    options.tracesSampleRate = 0.1  // 10% of transactions (adjust based on volume)

    // Enable ANR detection with thread dumps
    options.isAnrEnabled = true
    options.anrTimeoutIntervalMillis = 5000  // Default 5s ANR threshold
    options.isAttachAnrThreadDump = true     // Include thread dump in ANR events

    // Enable slow/frozen frame detection
    options.isEnableFramesTracking = true    // Track frame timing

    // Enable profiling for deeper analysis (optional, increases overhead)
    options.profilesSampleRate = 0.05  // 5% of sampled transactions
}
```

3. Verify the configuration follows Sentry Android 7.x API (research confirmed v7.3.0 is in project).

4. Add meaningful transaction names for key screens:

```kotlin
// In MainActivity or navigation setup
Sentry.getSpan()?.let { span ->
    span.setTag("screen", "interface_discovery")
}
```

**Important:** Sentry ANR v2 uses Google Play data source (more accurate than v1 heuristics). Verify the SDK version supports this automatically.

Run `./gradlew :app:assembleDebug` to verify build succeeds.
  </action>
  <verify>
1. Build succeeds: `./gradlew :app:assembleDebug`
2. Sentry initialization includes `tracesSampleRate` configuration
3. ANR settings include thread dump attachment
4. Frame tracking is enabled
  </verify>
  <done>Sentry performance monitoring is configured with slow frame and ANR detection.</done>
</task>

<task type="auto">
  <name>Task 2: Add JankStats integration for real-time frame monitoring</name>
  <files>app/src/main/java/com/lxmf/messenger/MainActivity.kt, app/build.gradle.kts</files>
  <action>
Add JankStats (official Jetpack library) for real-time frame monitoring and integration with Sentry.

**Step 1: Add dependency (if not already present):**

In app/build.gradle.kts dependencies:
```kotlin
implementation("androidx.metrics:metrics-performance:1.0.0-beta01")
```

**Step 2: Initialize JankStats in MainActivity:**

```kotlin
import androidx.metrics.performance.JankStats
import androidx.metrics.performance.PerformanceMetricsState

class MainActivity : ComponentActivity() {
    private lateinit var jankStats: JankStats

    private val jankFrameListener = JankStats.OnFrameListener { frameData ->
        // Report janky frames to Sentry as breadcrumbs
        if (frameData.isJank) {
            val durationMs = frameData.frameDurationUiNanos / 1_000_000
            Sentry.addBreadcrumb(Breadcrumb().apply {
                category = "performance"
                message = "Janky frame: ${durationMs}ms"
                level = if (durationMs > 100) SentryLevel.WARNING else SentryLevel.INFO
                setData("frame_duration_ms", durationMs)
                setData("states", frameData.states.joinToString { "${it.key}=${it.value}" })
            })

            // Log for local debugging
            Log.w(TAG, "Jank detected: ${durationMs}ms on ${frameData.states}")
        }
    }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        // Initialize JankStats after setContentView/setContent
        window.decorView.post {
            jankStats = JankStats.createAndTrack(window, jankFrameListener)

            // Add state for current screen context
            val metricsStateHolder = PerformanceMetricsState.getHolderForHierarchy(
                window.decorView
            )
            metricsStateHolder.state?.putState("Activity", "MainActivity")
        }
    }

    override fun onResume() {
        super.onResume()
        if (::jankStats.isInitialized) {
            jankStats.isTrackingEnabled = true
        }
    }

    override fun onPause() {
        super.onPause()
        if (::jankStats.isInitialized) {
            jankStats.isTrackingEnabled = false
        }
    }
}
```

**Step 3: Add screen context for navigation:**

When navigating to different screens, update the JankStats state:
```kotlin
metricsStateHolder.state?.putState("Screen", "InterfaceDiscovery")
```

This provides context in Sentry breadcrumbs when jank occurs.

Run `./gradlew :app:assembleDebug` to verify build.
  </action>
  <verify>
1. Build succeeds with JankStats dependency
2. MainActivity initializes JankStats on onCreate
3. Janky frames are logged with Sentry breadcrumbs
4. JankStats tracks screen context
  </verify>
  <done>JankStats is integrated to track frame timing and report jank to Sentry.</done>
</task>

<task type="auto">
  <name>Task 3: Verify Sentry integration in test run</name>
  <files>.planning/phases/01-performance-fix/01-MONITORING-VERIFICATION.md</files>
  <action>
Run a quick verification to confirm Sentry performance monitoring is capturing data.

**Verification Protocol:**

1. Build and install debug app with Sentry performance enabled
2. Navigate to Interface Discovery screen
3. Intentionally cause jank (rapid scrolling, heavy operations)
4. Check Sentry dashboard for:
   - Transaction traces with frame timing
   - Breadcrumbs with jank events
   - ANR detection (if triggered)

5. Document verification results:

```markdown
# Phase 1: Sentry Monitoring Verification

**Date:** {date}
**Build:** debug with Sentry performance

## Configuration Verified

- [x] Sentry DSN configured
- [x] tracesSampleRate set to 0.1 (10%)
- [x] ANR detection enabled with thread dumps
- [x] Frame tracking enabled
- [x] JankStats integrated

## Test Results

### Transaction Capture
- Transactions visible in Sentry: YES/NO
- Transaction names meaningful: YES/NO

### Jank Detection
- Janky frames logged locally: YES/NO
- Breadcrumbs appear in Sentry: YES/NO

### ANR Detection
- ANR triggerable in test: YES/NO (may skip if hard to trigger intentionally)
- ANR includes thread dump: YES/NO

## Sentry Dashboard Screenshots

[Optional: Include evidence of successful capture]

## Notes

[Any observations about monitoring behavior]
```

If verification fails, document what's not working and fix before completing.
  </action>
  <verify>
1. Sentry captures at least one performance transaction
2. JankStats logs jank events (visible in logcat)
3. Sentry breadcrumbs include frame timing data
  </verify>
  <done>Sentry performance monitoring is verified working with documented evidence.</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Sentry SDK configured for performance monitoring
2. JankStats integrated and tracking frames
3. Test run shows data appearing in Sentry
4. Documentation confirms monitoring is operational
</verification>

<success_criteria>
- Sentry captures slow frames automatically in production
- ANR detection enabled with thread dumps
- JankStats provides real-time frame monitoring
- Performance issues will be proactively detected going forward
</success_criteria>

<output>
After completion, create `.planning/phases/01-performance-fix/01-03-SUMMARY.md` documenting:
- Sentry configuration changes
- JankStats integration
- Verification results
- How to access performance data in Sentry dashboard
</output>
