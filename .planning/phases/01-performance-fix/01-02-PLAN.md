---
phase: 01-performance-fix
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - "[files determined by 01-FINDINGS.md]"
autonomous: true

must_haves:
  truths:
    - "All issues identified in 01-FINDINGS.md are fixed"
    - "Interface Discovery screen scrolls smoothly without stuttering"
    - "No progressive memory growth over 30+ minute soak test"
    - "UI responds within 200ms to user interactions"
  artifacts:
    - path: "[files modified per FINDINGS.md]"
      provides: "Fixed production code"
  key_links:
    - from: "01-FINDINGS.md"
      to: "code fixes"
      via: "proposed fixes applied"
      pattern: "each Issue N has corresponding fix"
---

<objective>
Apply fixes for all performance issues identified during Plan 01 investigation.

Purpose: Resolve UI stuttering and progressive degradation by implementing fixes from profiling findings.
Output: Fixed production code addressing all documented issues.
</objective>

<execution_context>
@/home/tyler/.claude/get-shit-done/workflows/execute-plan.md
@/home/tyler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-performance-fix/01-CONTEXT.md
@.planning/phases/01-performance-fix/01-RESEARCH.md
@.planning/phases/01-performance-fix/01-FINDINGS.md
@.planning/phases/01-performance-fix/01-01-SUMMARY.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONCERNS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Apply fixes for all documented performance issues</name>
  <files>[from 01-FINDINGS.md Issue sections]</files>
  <action>
Read 01-FINDINGS.md and implement the proposed fix for each documented issue.

**For each Issue in FINDINGS.md:**

1. Read the "Proposed Fix" section
2. Locate the affected files
3. Implement the fix following project conventions (CONVENTIONS.md)
4. Run relevant unit tests to verify no regressions

**Common fix patterns (from research):**

**If Memory Leak (ViewModel/Coroutine):**
- Ensure coroutines use `viewModelScope` not `GlobalScope`
- Cancel Jobs in `onCleared()` if using manual Job management
- Check for retained references in lambda closures

**If Memory Leak (Python/Chaquopy):**
- Check if Python objects are being retained in Kotlin collections
- Ensure proper lifecycle management of PyObject references
- If issue is in Reticulum Python code, create patch file in `python/patches/`

**If Compose Recomposition:**
- Add `@Stable` or `@Immutable` annotations to unstable data classes
- Consider using `kotlinx.collections.immutable.ImmutableList` for state collections
- Verify LazyColumn keys are stable (already confirmed correct in research)

**If Main Thread Blocking:**
- Move blocking operations to `Dispatchers.IO`
- Add `withContext(Dispatchers.IO)` around Python/Chaquopy calls
- Check for missing `suspend` modifiers on async operations

**If SharedFlow Buffer Growth:**
- Add `extraBufferCapacity` limits if unbounded
- Consider `conflate()` for rapid state updates
- Check for missing collectors causing buffer buildup

**Refactoring is acceptable** if it's the proper fix (per user decision). Document significant refactors in commit message.

Run after each fix:
```bash
./gradlew :app:testDebugUnitTest --tests "*DiscoveredInterfaces*"
./gradlew :app:testDebugUnitTest --tests "*ViewModel*" -x :reticulum:testDebugUnitTest
```
  </action>
  <verify>
1. Each issue in 01-FINDINGS.md has a corresponding code change
2. Unit tests pass: `./gradlew :app:testDebugUnitTest`
3. Build succeeds: `./gradlew :app:assembleDebug`
4. No new detekt violations: `./gradlew detektCheck`
  </verify>
  <done>All issues from FINDINGS.md have been fixed with passing tests.</done>
</task>

<task type="auto">
  <name>Task 2: Run verification profiling session</name>
  <files>.planning/phases/01-performance-fix/01-VERIFICATION-PROFILE.md</files>
  <action>
Run a verification profiling session to confirm fixes resolved the performance issues.

**Verification Protocol:**

1. **Build and install fixed app:**
   ```bash
   ./gradlew :app:installDebug
   ```

2. **Attach Android Studio Profiler:**
   - CPU profiler (Sample Java Methods)
   - Memory profiler (Track allocations)

3. **Scroll Test (Interface Discovery):**
   - Navigate to Interface Discovery screen
   - Scroll list for 60 seconds
   - **Verify:** No janky frames (all frames < 16ms target)
   - **Verify:** Frame timing 90th percentile < 16ms

4. **Soak Test (30 minutes):**
   - Leave on Interface Discovery screen
   - Capture heap dumps at T=0, T=15, T=30
   - **Verify:** Heap size stable (< 10% growth)
   - **Verify:** No LeakCanary notifications

5. **UI Responsiveness Test:**
   - Tap buttons and UI elements
   - **Verify:** Response time < 200ms

6. **Create verification report:**

```markdown
# Phase 1: Verification Profiling Results

**Date:** {date}
**Build:** debug (post-fix)

## Results Summary

| Requirement | Target | Actual | Status |
|-------------|--------|--------|--------|
| PERF-01: Responsive UI | <200ms response | X ms | PASS/FAIL |
| PERF-02: No degradation | <10% heap growth/30min | X% | PASS/FAIL |
| PERF-03: Smooth scroll | <16ms 90th percentile | X ms | PASS/FAIL |

## Memory Stability

| Time | Heap Size | Growth | Status |
|------|-----------|--------|--------|
| T=0  | X MB      | -      | Baseline |
| T=15 | X MB      | X%     | - |
| T=30 | X MB      | X%     | PASS/FAIL |

## Frame Timing (Post-Fix)

- Average frame time: X ms
- 90th percentile: X ms
- Janky frames (>16ms): X%

## LeakCanary

[Report status - expected: "No leaks detected"]

## Comparison to Pre-Fix

| Metric | Pre-Fix | Post-Fix | Improvement |
|--------|---------|----------|-------------|
| Heap growth/30min | X% | X% | X% reduction |
| 90th percentile frame | X ms | X ms | X% faster |

## Issues Fixed

[List each issue from FINDINGS.md and confirm it's resolved]
```

If any verification fails, document what failed and what additional fixes are needed.
  </action>
  <verify>
1. 01-VERIFICATION-PROFILE.md exists with all metrics
2. All three requirements (PERF-01, PERF-02, PERF-03) show PASS status
3. Heap growth < 10% over 30 minutes
4. No LeakCanary leaks detected
  </verify>
  <done>Verification profiling confirms all performance issues are resolved with measurable improvements.</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. All issues from 01-FINDINGS.md have corresponding fixes
2. Unit tests pass
3. Verification profiling shows PASS for all three requirements
4. No memory leaks detected
</verification>

<success_criteria>
- PERF-01: UI responds to interactions within 200ms
- PERF-02: Memory stable over 30+ minute soak test (< 10% growth)
- PERF-03: Interface Discovery scrolls at 60fps (< 16ms frame time)
- All documented issues from Plan 01 are resolved
</success_criteria>

<output>
After completion, create `.planning/phases/01-performance-fix/01-02-SUMMARY.md` documenting:
- Issues fixed (reference FINDINGS.md)
- Verification results (PASS/FAIL for each requirement)
- Any follow-up work identified
</output>
